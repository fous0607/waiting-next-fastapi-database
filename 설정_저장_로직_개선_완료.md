# 설정 저장 로직 개선 완료 (Self-Healing System)

## 1. 배경 및 문제점
- **증상:** 매장 설정 페이지에서 설정을 저장할 때, 새로운 기능(예: 대기관리자 버튼 크기, 음성 알림 설정 등)과 관련된 칼럼이 데이터베이스에 존재하지 않아 `500 Internal Server Error`가 발생함.
- **기존 대응:** 오류 발생 시 신규 설정값을 제외하고 저장하는 '안전 저장(Fallback)' 방식을 사용했으나, 이로 인해 사용자가 설정한 값이 저장되지 않고 초기화되는 문제(데이터 지속성 실패)가 발생함.
- **요구사항:** 데이터베이스 칼럼 추가 실패로 인한 저장 오류를 방지하고, 안정적인 데이터베이스 관리 시스템을 구축할 것.

## 2. 해결 방안: 자가 치유(Self-Healing) 및 자동 마이그레이션 시스템

### A. 지능형 자동 마이그레이션 (`core/db_auto_migrator.py`)
- **기능:** SQLAlchemy 모델(`models.py`)과 실제 데이터베이스 테이블을 실시간으로 비교 분석합니다.
- **작동:** 모델에는 정의되어 있지만 DB에 없는 칼럼을 감지하면, 데이터 타입과 기본값(Default Value)을 파악하여 자동으로 `ALTER TABLE ADD COLUMN` 쿼리를 실행합니다.
- **안전장치:** `server_default` 및 `nullable` 속성을 고려하여 기존 데이터가 있는 테이블에도 안전하게 칼럼을 추가합니다.

### B. 자가 치유 저장 로직 (`routers/store_settings.py`)
- **기존 로직:** 저장 시도 -> 실패 -> 일부 필드 버리고 저장 (데이터 유실).
- **개선된 로직:**
    1. **1차 시도:** 모든 설정값 저장을 시도합니다.
    2. **오류 감지:** `OperationalError` (칼럼 누락 등) 발생 시 이를 포착합니다.
    3. **자동 복구:** 즉시 `check_and_migrate_table` 함수를 호출하여 누락된 칼럼을 DB에 생성합니다.
    4. **재시도:** 복구 후 다시 모든 설정값 저장을 시도하여, **데이터 유실 없이 완벽하게 저장**합니다.
    5. **최후 방어:** 만약 복구조차 실패할 경우에만 기존의 안전 저장(Fallback)으로 전환합니다.

### C. 서버 시작 시 자동 점검 (`main.py`)
- 서버가 재시작될 때마다 주요 테이블(`StoreSettings`)의 스키마를 점검하고 최신 상태로 동기화하도록 설정하여, 배포 후 발생할 수 있는 잠재적 오류를 사전에 차단합니다.

## 3. 기대 효과
- **안정성 향상:** 개발자가 새로운 설정 기능을 추가하더라도, 별도의 복잡한 마이그레이션 절차 없이 코드를 배포하기만 하면 시스템이 알아서 DB를 최신화합니다.
- **사용자 경험 개선:** "저장 중 오류가 발생했습니다"라는 메시지를 볼 확률이 현저히 줄어들며, 설정한 값이 사라지는 현상이 해결되었습니다.
- **운영 효율성:** 반복되는 DB 칼럼 추가 작업 및 오류 대응 리소스를 절감할 수 있습니다.
